FROM node:22-alpine

RUN apk add --no-cache bash su-exec gcc musl-dev

ENV GZCTF_FLAG=STDIO2025_04{fake_flag_for_local}

WORKDIR /app
RUN npm init -y && npm install express@5 jst@0.0.13

RUN cat <<'EOF' > app.js
const express = require("express");
var jst = require("jst");
const app = express();
app.get("/", (req, res) => {
  const x = req.query.x || "";
  const bad = /flag|proto|env|global|mainModule|constructor|require|process|child_process|this|exec|{{|}}|\[|\]/;
  if (bad.test(x)) return res.status(400).send("bad request");
  res.send(jst.render(x, {}) + "");
});
app.listen(1337, () => console.log("App listening"));
EOF

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 1337
ENTRYPOINT ["/entrypoint.sh"]
